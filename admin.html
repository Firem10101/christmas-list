<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Christmas List Admin</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    background: url('https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.farmersalmanac.com%2Fwp-content%2Fuploads%2F2020%2F12%2FChristmas-Day-traditions-as_301005745.jpeg&f=1&nofb=1&ipt=5fec5f3eb60804cbac6eca77e3c7e28cc891b8d7a68c09544289a484bcb9bf56') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
  }

  h1 {
    text-align: center;
    text-shadow: 2px 2px 4px #000;
    margin-top: 20px;
  }

  #list {
    max-width: 800px;
    margin: 20px;
    padding: 10px;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 15px;
  }

  img {
    max-width: 100px;
    margin-right: 5px;
    border-radius: 5px;
  }

  .item {
    border: 2px solid #fff;
    border-radius: 10px;
    padding: 5px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: rgba(255, 0, 0, 0.3);
    transition: transform 0.2s, background-color 0.2s;
    cursor: grab;
  }

  .item:hover {
    transform: scale(1.03);
    background-color: rgba(0, 128, 0, 0.3);
  }

  button {
    padding: 5px 10px;
    background-color: gold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s;
    margin-left: 5px;
  }

  button:hover {
    background-color: #ffa500;
  }

  input, textarea {
    padding: 5px;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    width: 100%;
  }

  textarea {
    resize: vertical;
    min-height: 60px;
    white-space: pre-wrap;
    font-family: inherit;
  }

  #admin-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 300px;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    padding: 20px;
    overflow-y: auto;
    box-shadow: -5px 0 10px rgba(0,0,0,0.5);
  }
</style>
</head>
<body>

<h1>Admin Panel - Manage Christmas List</h1>

<div id="list"></div>

<div id="admin-panel">
  <h2>Add / Edit Item</h2>
  <input type="text" id="item-name" placeholder="Item Name">
  <input type="text" id="item-price" placeholder="Price">
  <textarea id="item-description" placeholder="Description (optional)"></textarea>
  <input type="text" id="item-link" placeholder="Item Link (optional)">
  <input type="file" id="item-image">
  <button id="add-btn" onclick="addItem()">Add Item</button>
  <button id="update-btn" style="display:none;" onclick="updateItem()">Update Item</button>
</div>

<!-- Reveal Claimed Items Button -->
<div style="margin-top:20px; display:flex; justify-content:flex-start;">
  <button id="reveal-claimed-btn" 
    style="background:#facc15; border:none; border-radius:8px; color:#000; font-weight:bold;
    padding:10px 20px; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
    Reveal Claimed Items
  </button>
</div>

<!-- Hidden Claimed Items List -->
<!-- Hidden Claimed Items List -->
<div id="claimed-list" 
  style="display:none; max-width:800px; margin:20px; padding:10px;
  background-color:rgba(0,0,0,0.5); border-radius:15px; color:white;">
  <h3 style="margin-top:0;">Claimed Items</h3>
  <div id="claimed-items-container"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-database-compat.js"></script>

<script>

let isAdmin = true; // Admin page is always authenticated

const firebaseConfig = {
  apiKey: "AIzaSyARtsrEkiRqyxEv6KfdC48TJt1RCcZZ_Kg",
  authDomain: "christmas-list-9a41e.firebaseapp.com",
  databaseURL: "https://christmas-list-9a41e-default-rtdb.firebaseio.com",
  projectId: "christmas-list-9a41e",
  storageBucket: "christmas-list-9a41e.appspot.com",
  messagingSenderId: "590904557299",
  appId: "1:590904557299:web:d6989710fe9049637fc186"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const itemsRef = db.ref('items');
const claimedRef = db.ref('claimedItems');
let editingKey = null;
let currentItemKey = null;

// LISTEN FOR ITEMS
itemsRef.on('value', snapshot => {
  const data = snapshot.val();
  const items = data ? Object.entries(data).map(([key, value]) => ({ key, ...value })) : [];
  items.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
  renderList(items);
});

// LISTEN FOR CLAIMED ITEMS
claimedRef.on('value', snapshot => {
  const data = snapshot.val();
  const items = data ? Object.entries(data).map(([key, value]) => ({ key, ...value })) : [];
  renderClaimedList(items);
});

// RENDER MAIN LIST
function renderList(items) {
  const listDiv = document.getElementById('list');
  listDiv.innerHTML = '';

  items.forEach(item => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'item';
    itemDiv.draggable = true;
    itemDiv.dataset.key = item.key;

    // Image
    if (item.image) {
      const img = document.createElement('img');
      img.src = item.image;
      itemDiv.appendChild(img);
    }

    // Text
    const textDiv = document.createElement('div');
    textDiv.innerHTML = `<strong>${item.name}</strong><br>$${item.price}<br><pre style="white-space: pre-wrap; margin:0;">${item.description || ''}</pre>${item.link ? `<br><a href="${item.link}" target="_blank" style="color:gold;">Link</a>` : ''}`;
    itemDiv.appendChild(textDiv);

    // Left arrow buttons
    const arrowDiv = document.createElement('div');
    arrowDiv.style.display = 'flex';
    arrowDiv.style.flexDirection = 'column';
    arrowDiv.style.marginRight = '10px';

    const upBtn = document.createElement('button');
    upBtn.textContent = '↑';
    upBtn.onclick = () => moveItem(item.key, -1);
    arrowDiv.appendChild(upBtn);

    const downBtn = document.createElement('button');
    downBtn.textContent = '↓';
    downBtn.onclick = () => moveItem(item.key, 1);
    arrowDiv.appendChild(downBtn);

    // Right edit/remove buttons
    const rightButtonsDiv = document.createElement('div');
    rightButtonsDiv.style.display = 'flex';
    rightButtonsDiv.style.flexDirection = 'row';
    rightButtonsDiv.style.gap = '10px';
    rightButtonsDiv.style.marginLeft = 'auto';

    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.onclick = () => editItem(item.key, item.name, item.price, item.image, item.description, item.link);
    rightButtonsDiv.appendChild(editBtn);

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = () => itemsRef.child(item.key).remove();
    rightButtonsDiv.appendChild(removeBtn);

    // Compose item
    itemDiv.style.display = 'flex';
    itemDiv.style.alignItems = 'center';
    itemDiv.appendChild(arrowDiv);
    itemDiv.appendChild(textDiv);
    itemDiv.appendChild(rightButtonsDiv);

    listDiv.appendChild(itemDiv);
  });
}

// RENDER CLAIMED ITEMS
function renderClaimedList(items) {
  const claimedContainer = document.getElementById('claimed-items-container');
  claimedContainer.innerHTML = '';

  items.forEach(item => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'item';

    if (item.image) {
      const img = document.createElement('img');
      img.src = item.image;
      itemDiv.appendChild(img);
    }

    const textDiv = document.createElement('div');
    textDiv.innerHTML = `<strong>${item.name}</strong><br>$${item.price}<br>
    <em>Claimed by: ${item.firstName || ''} ${item.lastName || ''}</em>`;
    itemDiv.appendChild(textDiv);

    // Add "Remove" button
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = async () => {
      // Add the item back to the main list
      const newItem = { 
        name: item.name, 
        price: item.price, 
        image: item.image || '', 
        description: item.description || '', 
        link: item.link || '', 
        order: Date.now() 
      };
      await itemsRef.push(newItem);

      // Remove from claimed
      claimedRef.child(item.key).remove();
    };
    itemDiv.appendChild(removeBtn);

    claimedContainer.appendChild(itemDiv);
  });
}

// ADD ITEM
function addItem() {
  if (!isAdmin) return alert("Only admin can add items!");
  const name = document.getElementById('item-name').value;
  const price = document.getElementById('item-price').value;
  const link = document.getElementById('item-link').value;
  const imageInput = document.getElementById('item-image');

  if (!name || !price) return alert('Please enter name and price');

  const pushItem = image => {
    const newItem = { name, price, image, link, order: Date.now() };
    itemsRef.push(newItem);
  };

  if (imageInput.files[0]) {
    const reader = new FileReader();
    reader.onload = e => pushItem(e.target.result);
    reader.readAsDataURL(imageInput.files[0]);
  } else pushItem('');

  document.getElementById('item-name').value = '';
  document.getElementById('item-price').value = '';
  document.getElementById('item-link').value = '';
  imageInput.value = '';
}

// EDIT ITEM
function editItem(key, name, price, image, description, link) {
  editingKey = key;
  document.getElementById('item-name').value = name;
  document.getElementById('item-price').value = price;
  document.getElementById('item-description').value = description || '';
  document.getElementById('item-link').value = link || '';
  document.getElementById('add-btn').style.display = 'none';
  document.getElementById('update-btn').style.display = 'block';
}

// UPDATE ITEM
function updateItem() {
  if (!editingKey) return;
  const name = document.getElementById('item-name').value;
  const price = document.getElementById('item-price').value;
  const description = document.getElementById('item-description').value;
  const link = document.getElementById('item-link').value;
  const imageInput = document.getElementById('item-image');

  if (!name || !price) return alert('Please enter name and price');

  itemsRef.child(editingKey).once('value', snapshot => {
    const oldItem = snapshot.val();
    const updatedItem = { name, price, description, link, image: oldItem.image, order: oldItem.order };

    if (imageInput.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        updatedItem.image = e.target.result;
        itemsRef.child(editingKey).set(updatedItem);
        resetAdminPanel();
      };
      reader.readAsDataURL(imageInput.files[0]);
    } else {
      itemsRef.child(editingKey).set(updatedItem);
      resetAdminPanel();
    }
  });
}

// RESET ADMIN PANEL
function resetAdminPanel() {
  document.getElementById('item-name').value = '';
  document.getElementById('item-price').value = '';
  document.getElementById('item-description').value = '';
  document.getElementById('item-image').value = '';
  document.getElementById('add-btn').style.display = 'block';
  document.getElementById('update-btn').style.display = 'none';
  editingKey = null;
}

// MOVE ITEM
function moveItem(key, direction) {
  itemsRef.once('value', snapshot => {
    const data = snapshot.val();
    if (!data) return;
    const items = Object.entries(data).map(([k, v]) => ({ key: k, ...v }));
    items.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

    const index = items.findIndex(item => item.key === key);
    if (index === -1) return;
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= items.length) return;

    const tempOrder = items[index].order;
    items[index].order = items[newIndex].order;
    items[newIndex].order = tempOrder;

    const updates = {};
    updates[items[index].key + '/order'] = items[index].order;
    updates[items[newIndex].key + '/order'] = items[newIndex].order;
    itemsRef.update(updates);
  });
}

// TOGGLE REVEAL CLAIMED ITEMS
document.getElementById('reveal-claimed-btn').addEventListener('click', () => {
  const claimedList = document.getElementById('claimed-list');
  const isVisible = claimedList.style.display === 'block';
  claimedList.style.display = isVisible ? 'none' : 'block';
  document.getElementById('reveal-claimed-btn').textContent = isVisible ? 'Reveal Claimed Items' : 'Hide Claimed Items';
});
</script>
</body>
</html>